.. sectnum::
   :start: 26

##################################
熟悉Angular测试
##################################

本章将带领读者熟悉并掌握Angular测试知识，为了更好的理解本章的内容，在这之前，需要先了解下测试相关的术语。


测试驱动开发和行为驱动开发
===================================
测试驱动开发，英文全称Test-Driven Development，简称TDD。它要求在编写某个功能的代码之前先编写测试代码，然后只编写使测试通过的功能代码，通过测试来推动整个开发的进行。这有助于编写简洁可用和高质量的代码，并加速开发过程。

测试驱动开发的优点是：

1. 能驱使系统最终的实现代码，都可以被测试代码所覆盖到，也即“每一行代码都可测”；
2. 测试代码作为实现代码的正确导向，最终演变为正确系统的行为，能让整个开发过程更加高效。

同时，它的局限性也很明确：

1. 项目的需求必须足够清晰；
2. 对于一个业务模型极其复杂、内部模块之间的相互依赖性非常强的项目，采用TDD反而会得不尝失，这会导致程序员在拆分接口和写测试代码的时候工作量非常大。

行为驱动开发（Behavior Drive Development），简称BDD，它把TDD中模糊的那一部分给明确了，强调开发、测试、BA、客户等所有项目相关人员都用自然语言来描述系统的行为。大家看到的描述一致，读到的内容一致，于是最终行为驱动开发产出的结果也应该是最符合用户期望的。

BDD使项目中的每个人都清楚了解功能的含义以及何时停止构建功能，它的示例可帮助企业清楚地了解所要提出的要求，并在获得要求后立即停止；TDD中的测试可帮助程序员清楚地了解要构建的内容并在构建后停止。因此，可以简单的理解BDD包含了TDD以及额外的需求分析。

功能测试和非功能测试
==============================
功能测试就是对产品的各功能进行验证，根据功能测试用例，逐项测试，检查产品是否达到用户要求的功能。进行功能测试以确保应用程序的功能符合需求规范。这是黑盒测试，不涉及应用程序源代码的详细信息。在执行功能测试时，重点应放在应用程序主要功能的用户友好性上。
要首先执行功能测试，我们需要识别测试输入并使用选定的测试输入值计算预期结果。然后执行测试用例，并将实际数据与预期结果进行比较。

功能测试按照类型划分，大致有3种：

1. 单元测试：单元测试通常由开发人员而不是测试人员完成，主要是在开发阶段测试应用程序的各个组件。测试一段代码形式的功能以验证准确性；
2. 集成测试：进行集成测试以检查应用程序的各个组件在集成时是否按预期运行。通常在单元测试之后进行集成测试；
3. 端到端测试（e2e）：它测试系统环境中所有的访问点，并在组件级和系统级的测试中将功能测试和性能测试整合在一起。


非功能测试指的是通过​​各种标准（例如负载测试，可伸缩性测试，压力测试等）评估应用程序的就绪状态。它评估应用程序在挑战性条件下的性能。

Angular的CLI工程默认集成了Jasmine和Karma测试工具。下面分别对它们进行介绍。

什么是Jasmine？
==================================
Jasmine是一个基于BDD(行为驱动开发)的JavaScript测试框架。它能运行在任何支持JavaScript的平台上，其本身不依赖于任何其它的Javascript框架，也不依赖于文档对象模型（DOM），Jasmine的语法简单且易于阅读，是前端应用的单元测试常用框架之一。如，Mocha也是一种常用的单元测试框架。

在Angular中，我们使用Jasmine测试框架来编写测试用例。Jasmine提供了编写测试用例的几个常见方法，它们是：

it()方法
***********************

声明一个具体的测试用例。it()方法接受两个参数：一个字符串和一个函数，字符串就是测试用例的名字，函数就是要执行的测试代码。

describe()方法
***********************
可以理解为一组测试用例，里面可以包含一组it测试用例。describe()方法接受两个参数：一个字符串和一个函数，字符串就是测试用例的名字，函数就是要执行的代码块，里面包含若干个it()和其他方法。

expect()方法
***********************
使用断言的方式来执行测试结果，expect()方法的参数是一个具体的值，这个值被称为实际值。同时，在expect()方法后需要跟某个匹配方法（Matcher），而匹配方法中的值称为期望值。

匹配方法（Matcher）
***********************
每个 Matcher 的返回结果是一个布尔值，它的作用就是在实际值和期望值之间作比较。下面代码例举几个Matcher示例：

 .. code-block:: TypeScript

   expect(a).toBe(true); // 期望变量a为true  
   expect(a).toEqual(true); // 期望变量a等于true  
   expect(a).toMatch(/reg/); // 期望变量a匹配reg正则表达式，也可以是字符串  
   expect(a.foo).toBeDefined(); // 期望a.foo已定义  
   expect(a.foo).toBeUndefined(); // 期望a.foo未定义  
   expect(a).toBeNull(); // 期望变量a为null  

启动（setup）和销毁（teardown）方法
*********************************************
为了使每一个测试用例，都可以重复的执行 setup 与 teardown 代码，Jasmine 提供了全局的 beforeEach() 和 afterEach 方法。beforeEach()方法会在每一个测试用例执行前运行，而 afterEach() 方法在每个测试用例执行后被调用。

什么是Karma？
==================================
Karma是一个对JavaScript代码执行提供多种浏览器运行环境的工具，简单的说，Karma就是供Jasmine测试时的运行平台。Karma可用于测试所有主流Web浏览器，也可集成到CI（Continuous integration）工具，也可和其他代码编辑器一起使用。
这个测试工具的一个强大特性就是，它可以监控(Watch)文件的变化，然后自行执行，通过console.log()方法显示测试结果。

使用Karma运行平台能让Angular应用程序完成下面这些场景的任务：

#. 在真实的浏览器中测试前端代码；
#. 在多平台、多浏览器中测试前端代码；
#. 在开发时本地能够进行前端测试；
#. 能将前端测试能够整合到持续集成实践中；
#. 每次文件的更新都会执行测试；
#. 能生成测试覆盖率报告。



Angular中的Jasmine和Karma的配置
***************************************
当使用Angular CLI命令构建项目时，该命令会自动生成与Karma和Jasmine一起使用的单元测试代码。例如，它会生成一个名为app.component.ts的应用程序组件和一个名为app.component.spec.ts的单元测试文件。在单元测试文件中默认已经生成了一些方法，用于直接对组件进行单元测试。

同时，在Angular项目的根目录下有个karma.conf.js文件，该文件是Jasmine测试框架的配置文件。


使用 Jasmine 编写测试用例
==================================


 .. code-block:: sh

   ng new test-ex100 -t -s --defaults=true

小结
==============